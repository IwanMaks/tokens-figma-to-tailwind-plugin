<!DOCTYPE html>
<html>
  <body style="font-family: sans-serif; padding: 16px">
    <h2>üé® Figma Tokens ‚Üí Tailwind</h2>
    <p>–°–æ–±–µ—Ä–∏ —Ç–æ–∫–µ–Ω—ã –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π —Ñ–∞–π–ª—ã.</p>

    <button id="export" style="padding: 8px 16px">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã</button>
    <div id="result" style="margin-top: 16px; white-space: pre-wrap"></div>

    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script>
      const exportButton = document.getElementById("export");
      const resultDiv = document.getElementById("result");

      exportButton.onclick = () => {
        // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –µ—ë
        exportButton.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        exportButton.disabled = true;
        resultDiv.textContent = "‚è≥ –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–∫–µ–Ω–æ–≤...";

        parent.postMessage({ pluginMessage: { type: "export-tokens" } }, "*");
      };

      // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–ª–∞–≥–∏–Ω–∞
      window.onmessage = async (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === "export-files") {
          await downloadZip(msg.files);

          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          exportButton.textContent = "–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã";
          exportButton.disabled = false;
        }
      };

      function getCurrentDateTimeString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        const seconds = String(now.getSeconds()).padStart(2, "0");
        return `${year}-${month}-${day}_${hours}-${minutes}-${seconds}`;
      }

      async function downloadZip(files) {
        const zip = new JSZip();
        files.forEach((f) => zip.file(f.name, f.content));

        const currentDate = getCurrentDateTimeString();
        const fileName = `tokens_${currentDate}.zip`;
        const blob = await zip.generateAsync({ type: "blob" });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();

        resultDiv.textContent = `‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!\n\n–§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ ${fileName}`;
      }
    </script>
  </body>
</html>
